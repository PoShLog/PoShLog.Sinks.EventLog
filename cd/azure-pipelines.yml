trigger:
  branches:
    include:
    - releases/*

# Disable PullRequest Validation
pr: none

pool:
  vmImage: 'windows-latest'

steps:
- checkout: self
  persistCredentials: true
  clean: true

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      Install-PackageProvider -Name NuGet -Force -Scope CurrentUser
      Install-Module -Name PoShLog.Tools -Force -Verbose -Scope CurrentUser
      Import-Module -Name PoShLog.Tools
      Bootstrap '.\cd\RequiredModules.psd1'
      Expand-VersionFromBranch -BranchName $(Build.SourceBranch)

- powershell: Invoke-Build '.\src\PoShLog.Sinks.EventLog.Build.ps1' -Configuration 'Prod' -Task Clean, BuildDependencies, UpdateManifest, CopyModuleFiles -ModuleVersion "$(MajorVersion).$(MinorVersion).$(BugfixVersion)" -PreRelease "$(VersionLabel)"
  displayName: 'Publish PowerShell Module'
  env:
    psgallery: $(NugetAPIKey)

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '.\src\output\PoShLog.Sinks.EventLog'
    includeRootFolder: true
    archiveType: 'zip'
    archiveFile: '$(Build.ArtifactStagingDirectory)/PoShLog.Sinks.EventLog_$(Build.BuildId).zip'
    replaceExistingArchive: true